FROM python:3.12-slim-bookworm

WORKDIR /app

# Install system dependencies including libpq for psycopg
RUN apt-get update && apt-get install -y \
    build-essential \
    curl \
    libpq-dev \
    && rm -rf /var/lib/apt/lists/*

# Install Python dependencies including Faker
RUN pip install --no-cache-dir \
    pyarrow \
    flightsql-dbapi \
    pymysql \
    mysql-connector-python \
    "psycopg[binary]" \
    psycopg2-binary \
    tabulate \
    faker

# Copy application files
COPY ./tests/scripts .
COPY ./tests/query_data.py .
COPY ./tests/test_client.py .
COPY ./tests/test_client_mutable.py .
COPY ./tests/test_schema.py .
COPY ./tests/mysql_test_client.py .
COPY ./tests/postgres_test_client.py .
COPY ./tests/create_test_data.py .

RUN chmod +x /app/http_healthcheck.sh
RUN chmod +x /app/add_connections.sh
RUN chmod +x /app/startup.sh

# Create directories where volumes will be mounted
RUN mkdir -p /app/mariadb1_init
RUN mkdir -p /app/mariadb2_init